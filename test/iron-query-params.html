<!doctype html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
<head>
  <title>iron-location</title>

  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../web-component-tester/browser.js"></script>

  <link rel="import" href="../../polymer/polymer.html">
  <link rel="import" href="../../promise-polyfill/promise-polyfill.html">
  <link rel="import" href="../iron-query-params.html">
  <link rel="import" href="./urlsearchparams.html">
</head>
<body>

  <test-fixture id="BasicQueryParams">
    <template>
      <iron-query-params></iron-query-params>
    </template>
  </test-fixture>

  <script>
    'use strict';

    suite('<iron-query-params>', function () {

      var paramsElem;
      var expectedSearchParams;
      setup(function() {
        paramsElem = fixture('BasicQueryParams');
      });

      test('basic functionality with ?key=value params', function() {
        // Check initialization
        expect(paramsElem.paramsString).to.be.eq('');
        expectedSearchParams = new URLSearchParams();
        expect(URLSearchParamsUtil.equal(
          paramsElem.paramsObject,
          expectedSearchParams
        )).to.be.true;

        // Check the mapping from paramsString to paramsObject.
        paramsElem.paramsString = 'greeting=hello&target=world';
        expectedSearchParams = new URLSearchParams([
          ['greeting', 'hello'], 
          ['target', 'world']
        ]);
        expect(URLSearchParamsUtil.equal(
          paramsElem.paramsObject,
          expectedSearchParams
        )).to.be.true;

        // Check the mapping from paramsString to paramsObject 
        // with multiple values for the same key
        // NOTE: order matters in the creation for URLSearchParams
        //       the spec has a sequence (which is ordered) as one of
        //       the valid constructor inits. This could be ameliorated
        //       with the .sort method, but only Firefox implements it
        //       as of July 2017. 
        paramsElem.paramsString = 
          'greeting=hello&target=world&greeting=hola&target=mundo';
        expectedSearchParams = new URLSearchParams([
          ['greeting', 'hello'],
          ['target', 'world'],
          ['greeting', 'hola'],
          ['target', 'mundo']
        ]);
        expect(URLSearchParamsUtil.equal(
          paramsElem.paramsObject,
          expectedSearchParams
        )).to.be.true;

        // Check the mapping from paramsObject back to paramsString.
        let newParamsObject = new URLSearchParams(paramsElem.paramsObject);
        newParamsObject.append('another', 'key');
        paramsElem.set('paramsObject', newParamsObject);
        expect(paramsElem.paramsString).to.be.equal(
          'greeting=hello&target=world&greeting=hola&target=mundo&another=key');
      });
      test('encoding of params', function() {
        var mappings = [
          {
            string: 'a=b',
            object: {'a': 'b'}
          },
          {
            string: 'debug=&ok=',
            object: {'debug': '', 'ok': ''}
          },
          {
            string: 'monster%20kid%3A=%F0%9F%98%BF&quotes=%27%27',
            object: {'monster kid:': 'ðŸ˜¿', 'quotes': '\'\''}
          },
          {
            string: 'yes%2C%20ok?%20what%20is%20up%20with%20%CB%9Athiiis%CB%9A=%E2%98%83',
            object: {'yes, ok? what is up with ËšthiiisËš': 'â˜ƒ'}
          },
        ];

        mappings.forEach(function(mapping) {
          // Clear
          paramsElem.paramsObject = new URLSearchParams();
          expect(paramsElem.paramsString).to.be.equal('');

          // Test going from string to object
          paramsElem.paramsString = mapping.string;
          console.log(paramsElem.paramsObject.toString(), mapping.string);
          expect(URLSearchParamsUtil.equal(
            paramsElem.paramsObject,
            new URLSearchParams(
              URLSearchParamsUtil.objectToArray(mapping.object)
            )
          )).to.be.true;

          // Clear again.
          paramsElem.paramsObject = new URLSearchParams();
          expect(paramsElem.paramsString).to.be.equal('');

          // Test going from object to string
          paramsElem.paramsObject = new URLSearchParams(
            URLSearchParamsUtil.objectToArray(mapping.object)
          );
          expect(paramsElem.paramsString).to.be.equal(mapping.string);
        });
      });
      test('query strings with alternative encodings', function() {
        // Check the mapping for querystrings with + instead of %20.
        paramsElem.paramsString = 'key=value+with+spaces';
        expect(URLSearchParamsUtil.equal(
          paramsElem.paramsObject,
          new URLSearchParams(
            URLSearchParamsUtil.objectToArray({key: 'value with spaces'})
          )
        )).to.be.true;
      });
    });

  </script>
</body>
